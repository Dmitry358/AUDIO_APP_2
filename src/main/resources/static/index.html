<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Local WebRTC Audio Call</title>
</head>
<body>

<h2>Local WebRTC Audio Callaaa</h2>
<button id="call">Позвонить</button>
<div id="status"></div>

<script>
    const statusEl = document.getElementById('status');
    statusEl.innerText = 'Инициализация...';

    // Подключаем WebSocket к Spring Boot
    const socket = new WebSocket("ws://localhost:8080/ws");

    const pc = new RTCPeerConnection({
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' }
        ]
    });

    // Получаем микрофон
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            console.log('Микрофон подключен:', stream);
            statusEl.innerText = 'Микрофон подключен';
            stream.getTracks().forEach(track => pc.addTrack(track, stream));
        })
        .catch(err => {
            console.error('Ошибка получения микрофона:', err);
            statusEl.innerText = 'Ошибка микрофона: ' + err.message;
        });

    // Когда приходит трек от другого пользователя
    pc.ontrack = event => {
        console.log('Пришёл трек:', event.streams[0]);
        let audio = document.createElement('audio');
        audio.srcObject = event.streams[0];
        audio.autoplay = true;
        audio.controls = true; // чтобы видеть прогресс
        document.body.appendChild(audio);
    };

    // Отправка ICE-кандидатов
    pc.onicecandidate = event => {
        if (event.candidate) {
            socket.send(JSON.stringify({ candidate: event.candidate }));
        }
    };

    // Обработка сообщений от WebSocket
    socket.onmessage = async (event) => {
        const data = JSON.parse(event.data);

        if (data.offer) {
            console.log('Пришёл offer');
            await pc.setRemoteDescription(data.offer);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.send(JSON.stringify({ answer }));
        }

        if (data.answer) {
            console.log('Пришёл answer');
            await pc.setRemoteDescription(data.answer);
        }

        if (data.candidate) {
            console.log('Пришёл candidate');
            await pc.addIceCandidate(data.candidate);
        }
    };

    document.getElementById('call').onclick = async () => {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.send(JSON.stringify({ offer }));
        console.log('Offer отправлен');
    };
</script>

</body>
</html>
